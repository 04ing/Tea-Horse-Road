<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>历史茶马古道地图 - 北宋、明、清对比</title>
    <!-- 统一使用Leaflet 1.9.4版本 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- 引入ECharts库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
</head>
<body>
    <!-- 顶部栏 -->
    <div class="top-bar">
        <button class="back-button" id="back-button">返回</button>
        <div class="top-bar-title">
            <h1 class="main-title">茶马古道历代对比分析</h1>
            <p class="subtitle">跨越千年的商贸文化之路：探索茶马古道在不同历史时期的发展与变迁</p>
        </div>
        <button class="comparison-button" id="comparison-button">朝代对比</button>
    </div>
    <div class="container">
        <!-- 北宋地图 -->
        <div class="dynasty-container">
            <div class="dynasty-title">北宋</div>
            <div id="song-map" class="map-container"></div>
            <div id="song-chart" class="chart-container"></div>
        </div>
        
        <!-- 明朝地图 -->
        <div class="dynasty-container">
            <div class="dynasty-title">明朝</div>
            <div id="ming-map" class="map-container"></div>
            <div id="ming-chart" class="chart-container"></div>
        </div>
        
        <!-- 清朝地图 -->
        <div class="dynasty-container">
            <div class="dynasty-title">清朝</div>
            <div id="qing-map" class="map-container"></div>
            <div id="qing-chart" class="chart-container"></div>
        </div>
    </div>
    
    <!-- 视频播放窗口 -->
    <div class="video-brown-container">
        <div class="video-title">茶马古道历史变迁</div>
        <div class="video-container">
            <video controls>
                <source src="chamagudao.mp4" type="video/mp4">
                您的浏览器不支持视频播放。
            </video>
        </div>
    </div>
    
    <!-- 柱状图容器 -->
    <div class="bar-charts-container">
        <div id="city-count-chart" class="bar-chart-item"></div>
        <div id="route-length-chart" class="bar-chart-item"></div>
        <div id="trade-volume-chart" class="bar-chart-item"></div>
        <div id="population-chart" class="bar-chart-item"></div>
    </div>

    <!-- 朝代对比弹窗 -->
    <div class="comparison-modal" id="comparison-modal">
        <div class="comparison-modal-content">
            <div class="comparison-modal-header">
                <h3 class="comparison-modal-title">朝代发展对比</h3>
                <button class="close-modal-btn" id="close-modal-btn">&times;</button>
            </div>
            <div class="comparison-modal-body">
                <div class="comparison-grid">
                    <div class="dynasty-card" id="song-card">
                        <h4>宋代</h4>
                        <div class="dynasty-info">
                            <strong>时期：</strong>960-1279年<br>
                            <strong>特点：</strong>茶马互市制度确立，形成以四川为中心的贸易网络<br>
                            <strong>主要路线：</strong>川藏线、陕藏线初步形成<br>
                            <strong>历史意义：</strong>开创了系统化的茶马贸易管理体系
                        </div>
                    </div>
                    <div class="dynasty-card" id="ming-card">
                        <h4>明代</h4>
                        <div class="dynasty-info">
                            <strong>时期：</strong>1368-1644年<br>
                            <strong>特点：</strong>设立茶马司，完善管理制度<br>
                            <strong>主要路线：</strong>川藏线、陕藏线进一步拓展，滇藏线初步形成<br>
                            <strong>历史意义：</strong>茶马古道成为连接内地与边疆的重要纽带
                        </div>
                    </div>
                    <div class="dynasty-card" id="qing-card">
                        <h4>清代</h4>
                        <div class="dynasty-info">
                            <strong>时期：</strong>1636-1912年<br>
                            <strong>特点：</strong>贸易规模扩大，路线更加完善<br>
                            <strong>主要路线：</strong>川藏、滇藏、陕藏三条主线形成，开通中俄万里茶道和海上贸易<br>
                            <strong>历史意义：</strong>茶马古道进入鼎盛时期
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    
    <script>
        // 全局变量
        var songMap, mingMap, qingMap;
        var songCitiesLayer, mingCitiesLayer, qingCitiesLayer;
        var songRoutesLayer, mingRoutesLayer, qingRoutesLayer;
        var songChart, mingChart, qingChart;
        var cityCountChart, routeLengthChart, tradeVolumeChart, populationChart;
        
        // 历史地图瓦片图层
        var songHistoricalLayer, mingHistoricalLayer, qingHistoricalLayer;
        
        // 模拟数据 - 实际应用中可以从API或文件加载
        var dynastyComparisonData = {
            // 城市数量数据
            cityCount: [
                {name: '北宋', value: 26},
                {name: '明朝', value: 61},
                {name: '清朝', value: 121}
            ],
            // 路线长度数据（公里）
            routeLength: [
                {name: '北宋', value: 5139.6},
                {name: '明朝', value: 6318.9},
                {name: '清朝', value: 16148.8}
            ],
            // 贸易量数据（万吨）
            tradeVolume: [
                {name: '北宋', value: 168},
                {name: '明朝', value: 84},
                {name: '清朝', value: 212}
            ],
            // 人口数据（亿）
            population: [
                {name: '北宋', value: 1.2},
                {name: '明朝', value: 1.85},
                {name: '清朝', value: 3.13}
            ]
        };

        // 初始化地图
        function initMaps() {
            console.log('初始化地图...');
            try {
                // 初始化北宋地图
                if (!document.getElementById('song-map')) {
                    console.error('找不到song-map容器');
                    showGlobalError('找不到北宋地图容器');
                } else {
                    songMap = L.map('song-map').setView([35.86166, 104.195397], 4);
                    initMapBaseLayer(songMap, 'song');
                }
                
                // 初始化明朝地图
                if (!document.getElementById('ming-map')) {
                    console.error('找不到ming-map容器');
                    showGlobalError('找不到明朝地图容器');
                } else {
                    mingMap = L.map('ming-map').setView([35.86166, 104.195397], 4);
                    initMapBaseLayer(mingMap, 'ming');
                }
                
                // 初始化清朝地图
                if (!document.getElementById('qing-map')) {
                    console.error('找不到qing-map容器');
                    showGlobalError('找不到清朝地图容器');
                } else {
                    qingMap = L.map('qing-map').setView([35.86166, 104.195397], 4);
                    initMapBaseLayer(qingMap, 'qing');
                }
                
                console.log('地图初始化完成');
            } catch (error) {
                console.error('地图初始化异常:', error);
                showGlobalError('地图初始化失败: ' + error.message);
            }
        }

        // 显示全局错误信息
        function showGlobalError(message) {
            var errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translateX(-50%)';
            errorDiv.style.backgroundColor = 'rgba(255, 0, 0, 0.9)';
            errorDiv.style.color = 'white';
            errorDiv.style.padding = '10px 20px';
            errorDiv.style.borderRadius = '4px';
            errorDiv.style.zIndex = '9999';
            errorDiv.style.fontWeight = 'bold';
            errorDiv.innerHTML = message;
            
            document.body.appendChild(errorDiv);
            
            // 1秒后自动消失
            setTimeout(function() {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 5000);
        }

        // 检查JSON文件是否存在
        function checkJsonFileExists(filePath) {
            return fetch(filePath)
                .then(response => {
                    console.log('检查文件:', filePath, '状态:', response.ok);
                    if (!response.ok) {
                        throw new Error(`文件不存在或无法访问: ${filePath}`);
                    }
                    return true;
                })
                .catch(error => {
                    console.error('文件检查失败:', error);
                    showGlobalError(error.message);
                    return false;
                });
        }

         // 初始化地图底图
        function initMapBaseLayer(map, dynasty) {
            console.log('初始化地图底图:', dynasty);
            // 添加ESRI卫星底图
            var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
            }).addTo(map);
            
            // 定义基础图层控制
            var baseLayers = {
                '卫星底图': satelliteLayer
            };
            
            // 定义覆盖层
            var overlays = {};
            
            // 历史地图瓦片图层URL
            var historicalLayerUrl = '';
            
            // 获取朝代中文名称
            var dynastyName = dynasty === 'song' ? '北宋' : dynasty === 'ming' ? '明朝' : '清朝';
            
            // 根据朝代添加相应的历史地图图层作为覆盖层
            if (dynasty === 'song') {
                // 北宋地图（ad1111）
                historicalLayerUrl = 'https://gis.sinica.edu.tw/ccts/file-exists.php?img=ad1111-png-';
                songHistoricalLayer = L.tileLayer(historicalLayerUrl + '{z}-{x}-{y}', {
                    maxNativeZoom: 22,
                    maxZoom: 25,
                    attribution: '中央研究院人社中心GIS專題中心',
                    opacity: 0.9,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }).addTo(map); // 默认添加到地图上
                
                overlays['北宋历史地图'] = songHistoricalLayer;
            } else if (dynasty === 'ming') {
                // 明朝地图（ad1582）
                historicalLayerUrl = 'https://gis.sinica.edu.tw/ccts/file-exists.php?img=ad1582-png-';
                mingHistoricalLayer = L.tileLayer(historicalLayerUrl + '{z}-{x}-{y}', {
                    maxNativeZoom: 22,
                    maxZoom: 25,
                    attribution: '中央研究院人社中心GIS專題中心',
                    opacity: 0.9,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }).addTo(map); // 默认添加到地图上
                
                overlays['明朝历史地图'] = mingHistoricalLayer;
            } else if (dynasty === 'qing') {
                // 清朝地图（ad1820）
                historicalLayerUrl = 'https://gis.sinica.edu.tw/ccts/file-exists.php?img=ad1820-png-';
                qingHistoricalLayer = L.tileLayer(historicalLayerUrl + '{z}-{x}-{y}', {
                    maxNativeZoom: 22,
                    maxZoom: 25,
                    attribution: '中央研究院人社中心GIS專題中心',
                    opacity: 0.9,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }).addTo(map); // 默认添加到地图上
                
                overlays['清朝历史地图'] = qingHistoricalLayer;
            }
            
            // 添加图层控制（包含基础图层和覆盖层）
            L.control.layers(baseLayers, overlays).addTo(map);
            
            // 添加错误处理
            function addTileErrorHandling(layer, layerName) {
                if (layer && layer.on) {
                    layer.on('tileerror', function(error) {
                        console.error('加载瓦片失败:', error);
                        showTileServerError(map, layerName);
                    });
                    
                    layer.on('load', function() {
                        console.log(`${layerName}地图图层加载完成`);
                        // 可以在这里添加加载完成的提示或移除错误提示
                    });
                }
            }
            
            // 为图层添加错误处理
            addTileErrorHandling(satelliteLayer, '卫星底图');
            
            // 为存在的历史地图图层添加错误处理
            if (songHistoricalLayer) {
                addTileErrorHandling(songHistoricalLayer, '北宋历史地图');
            }
            if (mingHistoricalLayer) {
                addTileErrorHandling(mingHistoricalLayer, '明朝历史地图');
            }
            if (qingHistoricalLayer) {
                addTileErrorHandling(qingHistoricalLayer, '清朝历史地图');
            }
            
            // 检查瓦片服务器可访问性
              if (historicalLayerUrl) {
                  checkTileServerAccess(historicalLayerUrl, map, dynastyName);
              }
        }

        // 初始化饼图
        function initCharts() {
            // 初始化北宋饼图
            songChart = echarts.init(document.getElementById('song-chart'));
            // 初始化明朝饼图
            mingChart = echarts.init(document.getElementById('ming-chart'));
            // 初始化清朝饼图
            qingChart = echarts.init(document.getElementById('qing-chart'));
            
            // 默认饼图配置
            var defaultOption = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)',
                    textStyle: {
                        color: 'black'  
                    }
                },
                // 移除图例
                series: [
                    {
                        name: '城市类型',
                        type: 'pie',
                        radius: '70%',  // 实心饼图，只有一个半径值
                        avoidLabelOverlap: false,
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        },
                        label: {
                            show: false  // 隐藏饼图上的标签文字
                        },
                        data: []
                    }
                ]
            };
            
            songChart.setOption(defaultOption);
            mingChart.setOption(defaultOption);
            qingChart.setOption(defaultOption);
            
            // 初始化柱状图
            initBarCharts();
            
            // 初始化后添加响应式调整
            addResizeHandler();
        }

        // 初始化柱状图
        function initBarCharts() {
            // 城市数量柱状图
            cityCountChart = echarts.init(document.getElementById('city-count-chart'));
            cityCountChart.setOption({
                title: {
                    text: '各朝代城市数量对比',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dynastyComparisonData.cityCount.map(item => item.name)
                },
                yAxis: {
                    type: 'value',
                    name: '城市数量'
                },
                series: [
                    {
                        data: dynastyComparisonData.cityCount.map(item => item.value),
                        type: 'bar',
                        itemStyle: {
                            color: '#8884d8'
                        }
                    },
                    {
                        data: dynastyComparisonData.cityCount.map(item => item.value),
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            color: '#8884d8',
                            width: 3
                        },
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: {
                            color: '#8884d8',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    }
                ]
            });

            // 路线长度柱状图
            routeLengthChart = echarts.init(document.getElementById('route-length-chart'));
            routeLengthChart.setOption({
                title: {
                    text: '各朝代路线长度对比',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + ': ' + params[0].value + ' 公里';
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dynastyComparisonData.routeLength.map(item => item.name)
                },
                yAxis: {
                    type: 'value',
                    name: '路线长度(公里)'
                },
                series: [
                    {
                        data: dynastyComparisonData.routeLength.map(item => item.value),
                        type: 'bar',
                        itemStyle: {
                            color: '#82ca9d'
                        }
                    },
                    {
                        data: dynastyComparisonData.routeLength.map(item => item.value),
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            color: '#82ca9d',
                            width: 3
                        },
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: {
                            color: '#82ca9d',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    }
                ]
            });

            // 贸易量柱状图
            tradeVolumeChart = echarts.init(document.getElementById('trade-volume-chart'));
            tradeVolumeChart.setOption({
                title: {
                    text: '各朝代贸易量对比',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + ': ' + params[0].value + ' 万吨';
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dynastyComparisonData.tradeVolume.map(item => item.name)
                },
                yAxis: {
                    type: 'value',
                    name: '贸易量(万吨)'
                },
                series: [
                    {
                        data: dynastyComparisonData.tradeVolume.map(item => item.value),
                        type: 'bar',
                        itemStyle: {
                            color: '#ffc658'
                        }
                    },
                    {
                        data: dynastyComparisonData.tradeVolume.map(item => item.value),
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            color: '#ffc658',
                            width: 3
                        },
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: {
                            color: '#ffc658',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    }
                ]
            });

            // 人口柱状图
            populationChart = echarts.init(document.getElementById('population-chart'));
            populationChart.setOption({
                title: {
                    text: '各朝代主要城市人口对比',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + ': ' + params[0].value + ' 亿人';
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dynastyComparisonData.population.map(item => item.name)
                },
                yAxis: {
                    type: 'value',
                    name: '人口(万人)'
                },
                series: [
                    {
                        data: dynastyComparisonData.population.map(item => item.value),
                        type: 'bar',
                        itemStyle: {
                            color: '#ff8042'
                        }
                    },
                    {
                        data: dynastyComparisonData.population.map(item => item.value),
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            color: '#ff8042',
                            width: 3
                        },
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: {
                            color: '#ff8042',
                            borderColor: '#fff',
                            borderWidth: 2
                        }
                    }
                ]
            });
        }

        // 初始化清朝对俄茶贸易量图表
        function initQingRussiaTeaTradeChart() {
            console.log('初始化清朝对俄茶贸易量图表...');
            try {
                // 创建图表容器
                var chartContainer = document.getElementById('qing-russia-tea-trade-chart');
                if (!chartContainer) {
                    console.error('找不到qing-russia-tea-trade-chart容器');
                    showGlobalError('找不到清朝对俄茶贸易量图表容器');
                    return;
                }
                
                // 初始化图表
                qingRussiaTeaTradeChart = echarts.init(chartContainer);
                
                // 设置初始图表配置
                var initialOption = {
                    title: {
                        text: '清朝对俄茶贸易量动态趋势',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: ['加载中...'],
                        axisLabel: {
                            interval: 0,
                            rotate: 45
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '贸易量(吨)'
                    },
                    series: [
                        {
                            data: [0],
                            type: 'bar',
                            itemStyle: {
                                color: '#8dd1e1'
                            }
                        }
                    ],
                    animation: true,
                    animationDuration: 1000
                };
                
                qingRussiaTeaTradeChart.setOption(initialOption);
                
                // 尝试加载Excel文件
                loadExcelData();
                
            } catch (error) {
                console.error('初始化清朝对俄茶贸易量图表异常:', error);
                showGlobalError('初始化清朝对俄茶贸易量图表失败: ' + error.message);
            }
        }

        // 加载Excel文件数据
        function loadExcelData() {
            console.log('尝试加载清朝对俄茶贸易量Excel文件...');
            try {
                // 创建一个虚拟的文件输入元素来模拟文件选择
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                
                // 使用fetch API尝试读取本地文件
                // 注意：在浏览器安全策略下，通常不能直接通过文件路径读取本地文件
                // 这里使用一个回退方案，提供模拟数据并提示用户手动上传文件
                
                // 模拟数据 - 当无法直接读取文件时使用
                var mockData = {
                    years: ['1750', '1780', '1800', '1820', '1840', '1860', '1880', '1900'],
                    volumes: [5000, 15000, 30000, 50000, 80000, 120000, 180000, 200000]
                };
                
                // 更新图表为模拟数据
                updateTeaTradeChart(mockData);
                
                // 提示用户可以手动上传文件
                setTimeout(function() {
                    showUploadPrompt();
                }, 1000);
                
            } catch (error) {
                console.error('加载Excel文件失败:', error);
                showGlobalError('加载清朝对俄茶贸易量文件失败: ' + error.message);
            }
        }

        // 显示文件上传提示
        function showUploadPrompt() {
            var promptDiv = document.createElement('div');
            promptDiv.style.position = 'fixed';
            promptDiv.style.top = '20px';
            promptDiv.style.left = '50%';
            promptDiv.style.transform = 'translateX(-50%)';
            promptDiv.style.backgroundColor = 'rgba(0, 128, 0, 0.9)';
            promptDiv.style.color = 'white';
            promptDiv.style.padding = '10px 20px';
            promptDiv.style.borderRadius = '4px';
            promptDiv.style.zIndex = '9999';
            promptDiv.style.fontWeight = 'bold';
            promptDiv.innerHTML = '当前显示模拟数据，点击下方按钮可上传实际Excel文件';
            
            // 添加上传按钮
            var uploadBtn = document.createElement('button');
            uploadBtn.innerText = '上传Excel文件';
            uploadBtn.style.marginLeft = '10px';
            uploadBtn.style.padding = '5px 10px';
            uploadBtn.style.backgroundColor = '#fff';
            uploadBtn.style.color = '#000';
            uploadBtn.style.border = 'none';
            uploadBtn.style.borderRadius = '4px';
            uploadBtn.style.cursor = 'pointer';
            
            uploadBtn.addEventListener('click', function() {
                var input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx, .xls';
                
                input.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        var file = e.target.files[0];
                        handleExcelFile(file);
                    }
                });
                
                input.click();
            });
            
            promptDiv.appendChild(uploadBtn);
            document.body.appendChild(promptDiv);
            
            // 10秒后自动消失
            setTimeout(function() {
                if (document.body.contains(promptDiv)) {
                    document.body.removeChild(promptDiv);
                }
            }, 10000);
        }

        // 处理上传的Excel文件
        function handleExcelFile(file) {
            console.log('处理上传的Excel文件:', file.name);
            var reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    // 使用xlsx库解析文件
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    
                    // 将工作表转换为JSON
                    var jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // 处理数据
                    var processedData = processExcelData(jsonData);
                    
                    // 更新图表
                    updateTeaTradeChart(processedData);
                    
                    // 显示成功提示
                    showGlobalError('Excel文件加载成功！');
                    
                } catch (error) {
                    console.error('解析Excel文件失败:', error);
                    showGlobalError('解析Excel文件失败: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showGlobalError('读取Excel文件失败！');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // 处理Excel数据格式
        function processExcelData(jsonData) {
            console.log('处理Excel数据:', jsonData.length, '条记录');
            
            // 假设Excel文件包含年份和贸易量两列
            // 根据实际Excel结构调整列名
            var years = [];
            var volumes = [];
            
            jsonData.forEach(function(row, index) {
                // 跳过标题行
                if (index === 0) return;
                
                // 尝试不同的列名格式
                var year = row['年份'] || row['年'] || row['时间'] || '';
                var volume = row['贸易量'] || row['数量'] || row['交易量'] || 0;
                
                if (year && volume) {
                    years.push(year.toString());
                    volumes.push(parseFloat(volume) || 0);
                }
            });
            
            // 如果没有解析到数据，返回模拟数据
            if (years.length === 0) {
                return {
                    years: ['1750', '1780', '1800', '1820', '1840', '1860', '1880', '1900'],
                    volumes: [5000, 15000, 30000, 50000, 80000, 120000, 180000, 200000]
                };
            }
            
            return { years: years, volumes: volumes };
        }

        // 更新茶贸易量图表
        function updateTeaTradeChart(data) {
            console.log('更新茶贸易量图表数据:', data);
            
            if (!qingRussiaTeaTradeChart) {
                console.error('图表未初始化');
                return;
            }
            
            var option = {
                title: {
                    text: '清朝对俄茶贸易量动态趋势',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        return params[0].name + '年: ' + params[0].value + ' 吨';
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.years,
                    axisLabel: {
                        interval: 0,
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '贸易量(吨)',
                    axisLabel: {
                        formatter: function(value) {
                            if (value >= 10000) {
                                return (value / 10000) + '万吨';
                            }
                            return value;
                        }
                    }
                },
                series: [
                    {
                        data: data.volumes,
                        type: 'bar',
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: '#8dd1e1'},
                                {offset: 1, color: '#005588'}
                            ])
                        },
                        emphasis: {
                            itemStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    {offset: 0, color: '#aed1e1'},
                                    {offset: 1, color: '#0066aa'}
                                ])
                            }
                        },
                        animationDelay: function(idx) {
                            return idx * 100;
                        }
                    },
                    {
                        data: data.volumes,
                        type: 'line',
                        smooth: true,
                        lineStyle: {
                            color: '#ff6b6b',
                            width: 3
                        },
                        symbol: 'circle',
                        symbolSize: 8,
                        itemStyle: {
                            color: '#ff6b6b',
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        animationDelay: function(idx) {
                            return idx * 100 + 300;
                        }
                    }
                ],
                animationEasing: 'elasticOut',
                animationDelayUpdate: function(idx) {
                    return idx * 5;
                }
            };
            
            qingRussiaTeaTradeChart.setOption(option);
        }

        // 添加响应式调整处理函数
        function addResizeHandler() {
            window.addEventListener('resize', function() {
                // 确保图表对象已初始化
                if (songChart) songChart.resize();
                if (mingChart) mingChart.resize();
                if (qingChart) qingChart.resize();
                if (cityCountChart) cityCountChart.resize();
                if (routeLengthChart) routeLengthChart.resize();
                if (tradeVolumeChart) tradeVolumeChart.resize();
                if (populationChart) populationChart.resize();
                if (qingRussiaTeaTradeChart) qingRussiaTeaTradeChart.resize();
            });
        }

        // 将ArcGIS JSON转换为GeoJSON
        function arcgisToGeoJSON(arcgisJson) {
            var geoJson = {
                type: 'FeatureCollection',
                features: []
            };
            
            arcgisJson.features.forEach(function(feature) {
                var geoJsonFeature = {
                    type: 'Feature',
                    properties: feature.attributes,
                    geometry: null
                };
                
                // 根据几何类型转换
                if (arcgisJson.geometryType === 'esriGeometryPoint') {
                    geoJsonFeature.geometry = {
                        type: 'Point',
                        coordinates: [feature.geometry.x, feature.geometry.y]
                    };
                } else if (arcgisJson.geometryType === 'esriGeometryPolyline') {
                    geoJsonFeature.geometry = {
                        type: 'LineString',
                        coordinates: []
                    };
                    
                    // 解析路径坐标
                    var paths = feature.geometry.paths;
                    if (paths && paths.length > 0) {
                        // 取第一条路径（简化处理）
                        geoJsonFeature.geometry.coordinates = paths[0];
                    }
                }
                
                geoJson.features.push(geoJsonFeature);
            });
            
            return geoJson;
        }

        // 加载城市数据
        function loadCityData(filePath, map, layerVar) {
            console.log('尝试加载城市数据:', filePath);
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('城市数据加载成功:', filePath, '特征数量:', data.features.length);
                    // 转换为GeoJSON
                    var geoJson = arcgisToGeoJSON(data);
                    
                    // 创建图层
                    if (layerVar) {
                        map.removeLayer(layerVar);
                    }
                    
                    layerVar = L.geoJSON(geoJson, {
                        pointToLayer: function(feature, latlng) {
                            return L.marker(latlng, {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: '<div style="background-color:red;color:white;border-radius:50%;width:12px;height:12px;display:flex;align-items:center;justify-content:center;">●</div>',
                                    iconSize: [12, 12],
                                    iconAnchor: [6, 6]
                                })
                            }).bindPopup(`<b>${feature.properties.城市}</b><br>类型: ${feature.properties.类型}`);
                        }
                    }).addTo(map);
                    
                    // 更新全局变量
                    if (filePath.includes('Song')) songCitiesLayer = layerVar;
                    if (filePath.includes('Ming')) mingCitiesLayer = layerVar;
                    if (filePath.includes('Qing')) qingCitiesLayer = layerVar;
                    
                    // 更新饼图
                    updateCityTypeChart(data, filePath);
                })
                .catch(error => {
                    console.error('加载城市数据失败:', filePath, error);
                    // 添加错误提示到地图上
                    var errorMessage = `加载城市数据失败: ${error.message}`;
                    var errorDiv = L.control({
                        position: 'bottomright'
                    });
                    
                    errorDiv.onAdd = function(map) {
                        var div = L.DomUtil.create('div', 'info error-message');
                        div.innerHTML = `<strong>${errorMessage}</strong>`;
                        div.style.backgroundColor = 'rgba(255, 0, 0, 0.8)';
                        div.style.color = 'white';
                        div.style.padding = '5px 10px';
                        div.style.borderRadius = '4px';
                        div.style.fontSize = '12px';
                        return div;
                    };
                    
                    errorDiv.addTo(map);
                });
        }

        // 加载路径数据
        function loadRouteData(filePath, map, layerVar) {
            console.log('尝试加载路径数据:', filePath);
            fetch(filePath)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('路径数据加载成功:', filePath, '特征数量:', data.features.length);
                    // 转换为GeoJSON
                    var geoJson = arcgisToGeoJSON(data);
                    
                    // 创建图层
                    if (layerVar) {
                        map.removeLayer(layerVar);
                    }
                    
                    layerVar = L.geoJSON(geoJson, {
                        style: function(feature) {
                            return {
                                color: 'blue',
                                weight: 3,
                                opacity: 0.6
                            };
                        }
                    }).addTo(map);
                    
                    // 更新全局变量
                    if (filePath.includes('Song')) songRoutesLayer = layerVar;
                    if (filePath.includes('Ming')) mingRoutesLayer = layerVar;
                    if (filePath.includes('Qing')) qingRoutesLayer = layerVar;
                })
                .catch(error => {
                    console.error('加载路径数据失败:', filePath, error);
                });
        }

        // 检查远程地图瓦片是否可访问
        function checkTileServerAccess(url, map, dynasty) {
            console.log('检查瓦片服务器可访问性:', url);
            fetch(url + '0/0/0') // 尝试加载最顶层瓦片
                .then(response => {
                    if (response.ok) {
                        console.log('瓦片服务器可访问:', url);
                    } else {
                        console.warn('瓦片服务器响应异常:', url, response.status);
                        // 不显示错误提示
                    }
                })
                .catch(error => {
                    console.error('瓦片服务器访问失败:', url, error);
                    // 不显示错误提示
                });
        }

        // 显示瓦片服务器错误信息 - 已禁用
        function showTileServerError(map, dynasty) {
            // 此函数已被禁用，不再显示瓦片加载失败警告
            console.log('瓦片服务器错误，但不显示警告:', dynasty);
        }

        // 更新城市类型饼图
        function updateCityTypeChart(data, filePath) {
            // 统计城市类型
            var typeCount = {};
            data.features.forEach(function(feature) {
                var type = feature.attributes.类型;
                if (typeCount[type]) {
                    typeCount[type]++;
                } else {
                    typeCount[type] = 1;
                }
            });
            
            // 转换为ECharts数据格式
            var chartData = [];
            for (var type in typeCount) {
                chartData.push({
                    name: type,
                    value: typeCount[type]
                });
            }
            
            // 更新对应朝代的饼图，保持tooltip文本为白色
            var chartOption = {
                backgroundColor: 'transparent',
                tooltip: {
                    textStyle: {
                        color: 'black'  // 确保tooltip文本始终为黑色
                    }
                },
                series: [
                    {
                        data: chartData
                    }
                ]
            };
            
            if (filePath.includes('Song') && songChart) songChart.setOption(chartOption);
            if (filePath.includes('Ming') && mingChart) mingChart.setOption(chartOption);
            if (filePath.includes('Qing') && qingChart) qingChart.setOption(chartOption);
        }

        // 页面加载完成后初始化
        window.onload = function() {
            console.log('页面加载完成，开始初始化...');
            // 检查是否加载了Leaflet库
            if (typeof L === 'undefined') {
                console.error('Leaflet库未加载成功！');
                showGlobalError('地图库加载失败，请刷新页面重试。');
                return;
            }
            
            try {
                console.log('初始化地图...');
                initMaps();
                console.log('初始化图表...');
                initCharts();
                
                console.log('检查地图数据文件是否存在...');
                // 先检查所有需要的JSON文件是否存在
                Promise.all([
                    checkJsonFileExists('json/City_Song.json'),
                    checkJsonFileExists('json/CostPath_Song.json'),
                    checkJsonFileExists('json/City_Ming.json'),
                    checkJsonFileExists('json/CostPath_Ming.json'),
                    checkJsonFileExists('json/City_Qing.json'),
                    checkJsonFileExists('json/CostPath_Qing.json')
                ]).then(results => {
                    // 只有当所有文件检查都通过时才加载数据
                    if (results.every(result => result === true)) {
                        console.log('所有数据文件都存在，开始加载地图数据...');
                        // 加载北宋数据
                        loadCityData('json/City_Song.json', songMap, songCitiesLayer);
                        loadRouteData('json/CostPath_Song.json', songMap, songRoutesLayer);
                        
                        // 加载明朝数据
                        loadCityData('json/City_Ming.json', mingMap, mingCitiesLayer);
                        loadRouteData('json/CostPath_Ming.json', mingMap, mingRoutesLayer);
                        
                        // 加载清朝数据
                        loadCityData('json/City_Qing.json', qingMap, qingCitiesLayer);
                        loadRouteData('json/CostPath_Qing.json', qingMap, qingRoutesLayer);
                    } else {
                        console.warn('部分数据文件不存在或无法访问，地图可能无法完整显示');
                        showGlobalError('部分数据文件不存在或无法访问，地图可能无法完整显示');
                    }
                });
                
                addResizeHandler();
                
                // 添加顶部栏按钮事件监听
                document.getElementById('back-button').addEventListener('click', function() {
                    window.location.href = 'route.html';
                });
                
                // 朝代对比弹窗控制
                const comparisonModal = document.getElementById('comparison-modal');
                const comparisonButton = document.getElementById('comparison-button');
                const closeModalButton = document.getElementById('close-modal-btn');
                
                comparisonButton.addEventListener('click', function() {
                    comparisonModal.style.display = 'flex';
                });
                
                closeModalButton.addEventListener('click', function() {
                    comparisonModal.style.display = 'none';
                });
                
                // 点击弹窗外部关闭弹窗
                comparisonModal.addEventListener('click', function(event) {
                    if (event.target === comparisonModal) {
                        comparisonModal.style.display = 'none';
                    }
                });
                
                // 按ESC键关闭弹窗
                document.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' && comparisonModal.style.display === 'flex') {
                        comparisonModal.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('地图初始化失败:', error);
                showGlobalError('地图初始化失败，请刷新页面重试。错误信息：' + error.message);
            }
        };
    </script>
</body>
</html>
